document.addEventListener("DOMContentLoaded", (e) => { 

    var emojis = "ðŸ˜€ ðŸ˜ƒ ðŸ˜„ ðŸ˜ ðŸ˜† ðŸ˜… ðŸ˜‚ ðŸ¤£ ðŸ˜Š ðŸ˜‡ ðŸ™‚ ðŸ™ƒ ðŸ˜‰ ðŸ˜Œ ðŸ˜ ðŸ˜˜ ðŸ˜— ðŸ˜™ ðŸ˜š ðŸ˜‹ ðŸ˜œ ðŸ˜ ðŸ˜› ðŸ¤‘ ðŸ¤— ðŸ¤“ ðŸ˜Ž ðŸ¤¡ ðŸ¤  ðŸ˜ ðŸ˜’ ðŸ˜ž ðŸ˜” ðŸ˜Ÿ ðŸ˜• ðŸ™ ðŸ˜£ ðŸ˜– ðŸ˜« ðŸ˜© ðŸ˜¤ ðŸ˜  ðŸ˜¡ ðŸ˜¶ ðŸ˜ ðŸ˜‘ ðŸ˜¯ ðŸ˜¦ ðŸ˜§ ðŸ˜® ðŸ˜² ðŸ˜µ ðŸ˜³ ðŸ˜± ðŸ˜¨ ðŸ˜° ðŸ˜¢ ðŸ˜¥ ðŸ¤¤ ðŸ˜­ ðŸ˜“ ðŸ˜ª ðŸ˜´ ðŸ™„ ðŸ¤” ðŸ¤¥ ðŸ˜¬ ðŸ¤ ðŸ¤¢ ðŸ¤§ ðŸ˜· ðŸ¤’ ðŸ¤• ðŸ˜ˆ ðŸ‘¿ ðŸ‘¹ ðŸ‘º ðŸ’© ðŸ‘» ðŸ’€ â˜ ï¸ ðŸ‘½ ðŸ‘¾ ðŸ¤– ðŸŽƒ ðŸ˜º ðŸ˜¸ ðŸ˜¹ ðŸ˜» ðŸ˜¼ ðŸ˜½ ðŸ™€ ðŸ˜¿ ðŸ˜¾ ðŸ‘ ðŸ™Œ ðŸ‘ ðŸ™ ðŸ¤ ðŸ‘ ðŸ‘Ž ðŸ‘Š âœŠ ðŸ¤› ðŸ¤œ ðŸ¤ž âœŒï¸ ðŸ¤˜ ðŸ‘Œ ðŸ‘ˆ ðŸ‘‰ ðŸ‘† ðŸ‘‡ â˜ï¸ âœ‹ ðŸ¤š ðŸ– ðŸ–– ðŸ‘‹ ðŸ¤™ ðŸ’ª ðŸ–• âœï¸ ðŸ¤³ ðŸ’… ðŸ–– ðŸ’„ ðŸ’‹ ðŸ‘„ ðŸ‘… ðŸ‘‚ ðŸ‘ƒ ðŸ‘£ ðŸ‘ ðŸ‘€ ðŸ—£ ðŸ‘¤ ðŸ‘¥ ðŸ‘¶ ðŸ‘¦ ðŸ‘§ ðŸ‘¨ ðŸ‘© ðŸ‘± ðŸ‘´ ðŸ‘µ ðŸ‘² ðŸ‘³ ðŸ‘® ðŸ‘· ðŸ’‚ ðŸ•µï¸ ðŸ‘©â€âš•ï¸ ðŸ‘¨â€âš•ï¸ ðŸ‘©â€ðŸŒ¾ ðŸ‘¨â€ðŸŒ¾ ðŸ‘©â€ðŸ³ ðŸ‘¨â€ðŸ³ ðŸ‘©â€ðŸŽ“ ðŸ‘¨â€ðŸŽ“ ðŸ‘©â€ðŸŽ¤ ðŸ‘¨â€ðŸŽ¤ ðŸ‘©â€ðŸ« ðŸ‘¨â€ðŸ« ðŸ‘©â€ðŸ­ ðŸ‘¨â€ðŸ­ ðŸ‘©â€ðŸ’» ðŸ‘¨â€ðŸ’» ðŸ‘©â€ðŸ’¼ ðŸ‘¨â€ðŸ’¼ ðŸ‘©â€ðŸ”§ ðŸ‘¨â€ðŸ”§ ðŸ‘©â€ðŸ”¬ ðŸ‘¨â€ðŸ”¬ ðŸ‘©â€ðŸŽ¨ ðŸ‘¨â€ðŸŽ¨ ðŸ‘©â€ðŸš’ ðŸ‘¨â€ðŸš’ ðŸ‘©â€âœˆï¸ ðŸ‘¨â€âœˆï¸ ðŸ‘©â€ðŸš€ ðŸ‘¨â€ðŸš€ ðŸ‘©â€âš–ï¸ ðŸ‘¨â€âš–ï¸ ðŸ¤¶ ðŸŽ… ðŸ‘¸ ðŸ¤´ ðŸ‘° ðŸ¤µ ðŸ‘¼ ðŸ¤° ðŸ™‡ ðŸ’ ðŸ™… ðŸ™† ðŸ™‹ ðŸ™Ž ðŸ™ ðŸ’‡ ðŸ’† ðŸ•´ ðŸ’ƒ ðŸ•º ðŸ‘¯ ðŸš¶ ðŸƒ ðŸ‘« ðŸ‘­ ðŸ‘¬ ðŸ’‘ ðŸ‘©â€â¤ï¸â€ðŸ‘© ðŸ‘¨â€â¤ï¸â€ðŸ‘¨ ðŸ’ ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘© ðŸ‘¨â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨ ðŸ‘ª ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ ðŸ‘©â€ðŸ‘©â€ðŸ‘¦ ðŸ‘©â€ðŸ‘©â€ðŸ‘§ ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‘©â€ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ ðŸ‘©â€ðŸ‘©â€ðŸ‘§â€ðŸ‘§ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§ ðŸ‘©â€ðŸ‘¦ ðŸ‘©â€ðŸ‘§ ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‘©â€ðŸ‘¦â€ðŸ‘¦ ðŸ‘©â€ðŸ‘§â€ðŸ‘§ ðŸ‘¨â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘§ ðŸ‘¨â€ðŸ‘§â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¦â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘§â€ðŸ‘§ ðŸ‘š ðŸ‘• ðŸ‘– ðŸ‘” ðŸ‘— ðŸ‘™ ðŸ‘˜ ðŸ‘  ðŸ‘¡ ðŸ‘¢ ðŸ‘ž ðŸ‘Ÿ ðŸ‘’ ðŸŽ© ðŸŽ“ ðŸ‘‘ â›‘ ðŸŽ’ ðŸ‘ ðŸ‘› ðŸ‘œ ðŸ’¼ ðŸ‘“ ðŸ•¶ ðŸŒ‚ â˜‚ï¸ ðŸ¶ ðŸ± ðŸ­ ðŸ¹ ðŸ° ðŸ¦Š ðŸ» ðŸ¼ ðŸ¨ ðŸ¯ ðŸ¦ ðŸ® ðŸ· ðŸ½ ðŸ¸ ðŸµ ðŸ™Š ðŸ™‰ ðŸ™Š ðŸ’ ðŸ” ðŸ§ ðŸ¦ ðŸ¤ ðŸ£ ðŸ¥ ðŸ¦† ðŸ¦… ðŸ¦‰ ðŸ¦‡ ðŸº ðŸ— ðŸ´ ðŸ¦„ ðŸ ðŸ› ðŸ¦‹ ðŸŒ ðŸš ðŸž ðŸœ ðŸ•· ðŸ•¸ ðŸ¢ ðŸ ðŸ¦Ž ðŸ¦‚ ðŸ¦€ ðŸ¦‘ ðŸ™ ðŸ¦ ðŸ  ðŸŸ ðŸ¡ ðŸ¬ ðŸ¦ˆ ðŸ³ ðŸ‹ ðŸŠ ðŸ† ðŸ… ðŸƒ ðŸ‚ ðŸ„ ðŸ¦Œ ðŸª ðŸ« ðŸ˜ ðŸ¦ ðŸ¦ ðŸŽ ðŸ– ðŸ ðŸ ðŸ‘ ðŸ• ðŸ© ðŸˆ ðŸ“ ðŸ¦ƒ ðŸ•Š ðŸ‡ ðŸ ðŸ€ ðŸ¿ ðŸ¾ ðŸ‰ ðŸ² ðŸŒµ ðŸŽ„ ðŸŒ² ðŸŒ³ ðŸŒ´ ðŸŒ± ðŸŒ¿ â˜˜ï¸ ðŸ€ ðŸŽ ðŸŽ‹ ðŸƒ ðŸ‚ ðŸ ðŸ„ ðŸŒ¾ ðŸ’ ðŸŒ· ðŸŒ¹ ðŸ¥€ ðŸŒ» ðŸŒ¼ ðŸŒ¸ ðŸŒº ðŸŒŽ ðŸŒ ðŸŒ ðŸŒ• ðŸŒ– ðŸŒ— ðŸŒ˜ ðŸŒ‘ ðŸŒ’ ðŸŒ“ ðŸŒ” ðŸŒš ðŸŒ ðŸŒž ðŸŒ› ðŸŒœ ðŸŒ™ ðŸ’« â­ï¸ ðŸŒŸ âœ¨ âš¡ï¸ ðŸ”¥ ðŸ’¥ â˜„ï¸ â˜€ï¸ ðŸŒ¤ â›…ï¸ ðŸŒ¥ ðŸŒ¦ ðŸŒˆ â˜ï¸ ðŸŒ§ â›ˆ ðŸŒ© ðŸŒ¨ â˜ƒï¸ â›„ï¸ â„ï¸ ðŸŒ¬ ðŸ’¨ ðŸŒª ðŸŒ« ðŸŒŠ ðŸ’§ ðŸ’¦ â˜”ï¸ ðŸ ðŸŽ ðŸ ðŸŠ ðŸ‹ ðŸŒ ðŸ‰ ðŸ‡ ðŸ“ ðŸˆ ðŸ’ ðŸ‘ ðŸ ðŸ¥ ðŸ¥‘ ðŸ… ðŸ† ðŸ¥’ ðŸ¥• ðŸŒ½ ðŸŒ¶ ðŸ¥” ðŸ  ðŸŒ° ðŸ¥œ ðŸ¯ ðŸ¥ ðŸž ðŸ¥– ðŸ§€ ðŸ¥š ðŸ³ ðŸ¥“ ðŸ¥ž ðŸ¤ ðŸ— ðŸ– ðŸ• ðŸŒ­ ðŸ” ðŸŸ ðŸ¥™ ðŸŒ® ðŸŒ¯ ðŸ¥— ðŸ¥˜ ðŸ ðŸœ ðŸ² ðŸ¥ ðŸ£ ðŸ± ðŸ› ðŸš ðŸ™ ðŸ˜ ðŸ¢ ðŸ¡ ðŸ§ ðŸ¨ ðŸ¦ ðŸ° ðŸŽ‚ ðŸ® ðŸ­ ðŸ¬ ðŸ« ðŸ¿ ðŸ© ðŸª ðŸ¥› ðŸ¼ â˜•ï¸ ðŸµ ðŸ¶ ðŸº ðŸ» ðŸ¥‚ ðŸ· ðŸ¥ƒ ðŸ¸ ðŸ¹ ðŸ¾ ðŸ¥„ ðŸ´ ðŸ½ âš½ï¸ ðŸ€ ðŸˆ âš¾ï¸ ðŸŽ¾ ðŸ ðŸ‰ ðŸŽ± ðŸ“ ðŸ¸ ðŸ¥… ðŸ’ ðŸ‘ ðŸ â›³ï¸ ðŸ¹ ðŸŽ£ ðŸ¥Š ðŸ¥‹ â›¸ ðŸŽ¿ â›· ðŸ‚ ðŸ‹ï¸ ðŸ¤º â›¹ï¸ ðŸŒï¸ ðŸ„ ðŸŠ ðŸš£ ðŸ‡ ðŸš´ ðŸšµ ðŸŽ½ ðŸ… ðŸŽ– ðŸ¥‡ ðŸ¥ˆ ðŸ¥‰ ðŸ† ðŸµ ðŸŽ— ðŸŽ« ðŸŽŸ ðŸŽª ðŸŽ­ ðŸŽ¨ ðŸŽ¬ ðŸŽ¤ ðŸŽ§ ðŸŽ¼ ðŸŽ¹ ðŸ¥ ðŸŽ· ðŸŽº ðŸŽ¸ ðŸŽ» ðŸŽ² ðŸŽ¯ ðŸŽ³ ðŸŽ® ðŸŽ° ðŸš— ðŸš• ðŸš™ ðŸšŒ ðŸšŽ ðŸŽ ðŸš“ ðŸš‘ ðŸš’ ðŸš ðŸšš ðŸš› ðŸšœ ðŸ›´ ðŸš² ðŸ›µ ðŸ ðŸš¨ ðŸš” ðŸš ðŸš˜ ðŸš– ðŸš¡ ðŸš  ðŸšŸ ðŸšƒ ðŸš‹ ðŸšž ðŸš ðŸš„ ðŸš… ðŸšˆ ðŸš‚ ðŸš† ðŸš‡ ðŸšŠ ðŸš‰ ðŸš ðŸ›© âœˆï¸ ðŸ›« ðŸ›¬ ðŸš€ ðŸ›° ðŸ’º ðŸ›¶ â›µï¸ ðŸ›¥ ðŸš¤ ðŸ›³ â›´ ðŸš¢ âš“ï¸ ðŸš§ â›½ï¸ ðŸš ðŸš¦ ðŸš¥ ðŸ—º ðŸ—¿ ðŸ—½ â›²ï¸ ðŸ—¼ ðŸ° ðŸ¯ ðŸŸ ðŸŽ¡ ðŸŽ¢ ðŸŽ  â›± ðŸ– ðŸ â›° ðŸ” ðŸ—» ðŸŒ‹ ðŸœ ðŸ• â›ºï¸ ðŸ›¤ ðŸ›£ ðŸ— ðŸ­ ðŸ  ðŸ¡ ðŸ˜ ðŸš ðŸ¢ ðŸ¬ ðŸ£ ðŸ¤ ðŸ¥ ðŸ¦ ðŸ¨ ðŸª ðŸ« ðŸ© ðŸ’’ ðŸ› â›ªï¸ ðŸ•Œ ðŸ• ðŸ•‹ â›© ðŸ—¾ ðŸŽ‘ ðŸž ðŸŒ… ðŸŒ„ ðŸŒ  ðŸŽ‡ ðŸŽ† ðŸŒ‡ ðŸŒ† ðŸ™ ðŸŒƒ ðŸŒŒ ðŸŒ‰ ðŸŒ âŒšï¸ ðŸ“± ðŸ“² ðŸ’» âŒ¨ï¸ ðŸ–¥ ðŸ–¨ ðŸ–± ðŸ–² ðŸ•¹ ðŸ—œ ðŸ’½ ðŸ’¾ ðŸ’¿ ðŸ“€ ðŸ“¼ ðŸ“· ðŸ“¸ ðŸ“¹ ðŸŽ¥ ðŸ“½ ðŸŽž ðŸ“ž â˜Žï¸ ðŸ“Ÿ ðŸ“  ðŸ“º ðŸ“» ðŸŽ™ ðŸŽš ðŸŽ› â± â² â° ðŸ•° âŒ›ï¸ â³ ðŸ“¡ ðŸ”‹ ðŸ”Œ ðŸ’¡ ðŸ”¦ ðŸ•¯ ðŸ—‘ ðŸ›¢ ðŸ’¸ ðŸ’µ ðŸ’´ ðŸ’¶ ðŸ’· ðŸ’° ðŸ’³ ðŸ’Ž âš–ï¸ ðŸ”§ ðŸ”¨ âš’ ðŸ›  â› ðŸ”© âš™ï¸ â›“ ðŸ”« ðŸ’£ ðŸ”ª ðŸ—¡ âš”ï¸ ðŸ›¡ ðŸš¬ âš°ï¸ âš±ï¸ ðŸº ðŸ”® ðŸ“¿ ðŸ’ˆ âš—ï¸ ðŸ”­ ðŸ”¬ ðŸ•³ ðŸ’Š ðŸ’‰ ðŸŒ¡ ðŸš½ ðŸš° ðŸš¿ ðŸ› ðŸ›€ ðŸ›Ž ðŸ”‘ ðŸ— ðŸšª ðŸ›‹ ðŸ› ðŸ›Œ ðŸ–¼ ðŸ› ðŸ›’ ðŸŽ ðŸŽˆ ðŸŽ ðŸŽ€ ðŸŽŠ ðŸŽ‰ ðŸŽŽ ðŸ® ðŸŽ âœ‰ï¸ ðŸ“© ðŸ“¨ ðŸ“§ ðŸ’Œ ðŸ“¥ ðŸ“¤ ðŸ“¦ ðŸ· ðŸ“ª ðŸ“« ðŸ“¬ ðŸ“­ ðŸ“® ðŸ“¯ ðŸ“œ ðŸ“ƒ ðŸ“„ ðŸ“‘ ðŸ“Š ðŸ“ˆ ðŸ“‰ ðŸ—’ ðŸ—“ ðŸ“† ðŸ“… ðŸ“‡ ðŸ—ƒ ðŸ—³ ðŸ—„ ðŸ“‹ ðŸ“ ðŸ“‚ ðŸ—‚ ðŸ—ž ðŸ“° ðŸ““ ðŸ“” ðŸ“’ ðŸ“• ðŸ“— ðŸ“˜ ðŸ“™ ðŸ“š ðŸ“– ðŸ”– ðŸ”— ðŸ“Ž ðŸ–‡ ðŸ“ ðŸ“ ðŸ“Œ ðŸ“ ðŸ“Œ ðŸŽŒ ðŸ³ï¸ ðŸ´ ðŸ ðŸ³ï¸â€ðŸŒˆ âœ‚ï¸ ðŸ–Š ðŸ–‹ âœ’ï¸ ðŸ–Œ ðŸ– ðŸ“ âœï¸ ðŸ” ðŸ”Ž ðŸ” ðŸ” ðŸ”’ ðŸ”“ â¤ï¸ ðŸ’› ðŸ’š ðŸ’™ ðŸ’œ ðŸ–¤ ðŸ’” â£ï¸ ðŸ’• ðŸ’ž ðŸ’“ ðŸ’— ðŸ’– ðŸ’˜ ðŸ’ ðŸ”ˆ ðŸ”‡ ðŸ”‰ ðŸ”Š ðŸ”” ðŸ”• ðŸ“£ ðŸ“¢ ðŸ‘â€ðŸ—¨ ðŸ’¬ ðŸ’­ ðŸ—¯".split(" ");
    var len = emojis.length;
    var requiredEntropy = 132;
    var prefix = "01";

    var enc = new TextEncoder("utf-8");
    var key;

    var seedInput = document.getElementById("seed");

    async function getHash(str){
        var signature = await window.crypto.subtle.sign("HMAC", key, enc.encode(str));
        var b = new Uint8Array(signature);
        var hash = Array.prototype.map.call(b, x => ('00'+x.toString(16)).slice(-2)).join("");
        return {str: str, hash: hash};
    }

    function makeRandomSeed(){
        var str = "";
        var array = new Uint16Array(Math.ceil(requiredEntropy*Math.log(2)/Math.log(len)));
        window.crypto.getRandomValues(array);
        for (let i = 0; i < array.length; i++) {
            let n = Math.floor(array[i]*len/(1<<16)); // mapping random number to [0,len)
            str += emojis[n];
        }
        return str;
    }

    async function deriveKeys(str){
        var secret = enc.encode(str);
        var password = enc.encode("electrum");

        var key = await crypto.subtle.importKey(
                "raw", 
                secret, 
                "PBKDF2", 
                false, 
                ["deriveBits"]
            )
        var result = await crypto.subtle.deriveBits({
                    name: "PBKDF2", 
                    salt: password, 
                    iterations: 2048, 
                    hash: "sha-512"
                }, 
                key, 
                512
            );
        var b = new Uint8Array(result);
        var r = Array.prototype.map.call(b, x => ('00'+x.toString(16)).slice(-2)).join("");

        var node = bitcoin.HDNode.fromSeedHex(r);
        var xprv = node.toBase58();
        var xpub = node.neutered().toBase58();

        return { "xprv": xprv, "xpub": xpub };
    }

    async function display(o){
        seedInput.value = o.str;
        var keys = await deriveKeys(o.str);

        document.getElementById("hmac").innerHTML = o.hash;
        document.getElementById("xprv").innerHTML = keys.xprv;
        document.getElementById("xpub").innerHTML = keys.xpub;

        if(o.hash.startsWith(prefix)){
            seedInput.className = "is-valid";
        }else{
            seedInput.className = "is-invalid";
        }
    }

    async function makeSeed(){
        var str = makeRandomSeed();
        var o = await getHash(str);
        if(o.hash.startsWith(prefix)){
            display(o);
        }else{
            makeSeed();
        }
    }

    window.crypto.subtle.importKey(
        "raw", enc.encode("Seed version"), { name: "HMAC", hash: {name: "SHA-512"} }, false, ["sign", "verify"]
    ).then( k => {
        key = k;
        makeSeed();
    });

    seedInput.addEventListener('input', (e) => {
    	str = seedInput.value;
        getHash(str).then( o => {
            display(o);
        });
    });

});